# rMATS Workflow - COG Analysis 
Started: January 23, 2023

## Subprojects:
1. Risk groups rmats 
2. CBF-AML rmats
3. NPM-AML rmats
4. leukemic burden (WBC) rMATS
5. (as of 1/14) Race binary (Black and non-Black)
6. (as of 1/30) Relapse (overall) 
7. (as of 1/30) Relapse + NPM mutation
8. Other stats
  - Stats for high risk prevelenace in Black subgroup
  - Stats for leukemia burden prevalence in Black subgroup

Reference: https://github.com/jeneaadams/gadue-lab-collab/edit/main/notes/2022-DEC-12.md 

## Workflow

### 1. Getting the rMATS output files from Cavatica

```
cd kf_python_api 
conda create --prefix ./cavatica-api-env
conda activate ./cavatica-api-env
conda install -c conda-forge -c bioconda python=3 
pip install git+https://github.com/kids-first/kf-cavatica-python-tools.git 
git clone https://github.com/kids-first/kf-cavatica-python-tools.git

cd kf_python_api #if needed

conda activate ./cavatica-api-env

python ./kf-cavatica-python-tools/recipes/download_files.py --project_name COG_analysis --project_path 2021OCT23_COG_rmats-output --download_location /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/COG_rmats-output
```

### 2. ( FOR CAVATICA RUNS ) Subset the data into replicate groups from BAMs 

This requires some intermediate data manipulation, but it's quick and efficient with the proper combination of R and a simple command prompt. 

To do this, a CSV table with labeled rows is necessary. I downloaded this in the COG-pediatric-aml OneDrive folder as ```rna.pat.met_mergeUSI.csv``` as well as subsequent subgroups of the data. 

  
  - SUBSET the data in R.

```lowrisk = rna.pat.met_mergeUSI %>% filter(riskgrp == 10) ```

``` write.csv(lowrisk, "/Users/adamsj8/OneDrive\ - Children's Hospital of Philadelphia/COG-pediatric-AML/bam-lists/2023JAN12_lowrisk_bams.csv")```

  -  After extracting an R CSV of the bam list for each subgroup, I copied the 'name' column input into VScode and added commmas at the end of each line (remove the one on the last line). Save this as a txt file appropriately named. 
  - In the command line I used ``` tr --delete '\n' < lowrisk_bams.txt > lowrisk_bams_list.txt ``` to remove all the **newlines** in the files and this gave me a new **list** postfix file that I will use for the next step
    - I will repeat this for all subgroups, which will eventually be individual b1s and b2s for separate rMATS analysis

  - The files are locted in ```/mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/``` for each project


🌐 environment = ```rmats2```

```
python /mnt/isilon/xing_lab/aspera/adamsj/kfAML_BAMs/_2_csv_indices_from_bams.py --input-csv _2_aggregated.csv --group1-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/risk-groups/lowrisk_bams_list.txt --group2-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/risk-groups/highrisk_bams_list.txt
```

```
python /mnt/isilon/xing_lab/aspera/adamsj/kfAML_BAMs/_2_csv_indices_from_bams.py --input-csv _2_aggregated.csv --group1-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/cbf-aml/cbf-neg_bams_list.txt --group2-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/cbf-aml/cbf-pos_bams_list.txt
```

```
python /mnt/isilon/xing_lab/aspera/adamsj/kfAML_BAMs/_2_csv_indices_from_bams.py --input-csv _2_aggregated.csv --group1-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/npm-aml/npm-neg_bams_list.txt --group2-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/npm-aml/npm-pos_bams_list.txt
```

```
python /mnt/isilon/xing_lab/aspera/adamsj/kfAML_BAMs/_2_csv_indices_from_bams.py --input-csv _2_aggregated.csv --group1-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/leukemic-burden/low-wbc_bams_list.txt --group2-bams /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/leukemic-burden/high-wbc_bams_list.txt
```

    - This is originally located in ```/mnt/isilon/xing_lab/aspera/adamsj/kfAML_BAMs/_2_csv_indices_from_bams.py```
    - 📃 Copy _2_aggregated.csv to the cwd from the rmats output folder
    - The output should print to the terminal -- copy and paste the indices for step 3
    

#### Risk Output

> group_1_indices: 0,1,3,4,6,7,9,11,12,14,15,16,18,19,20,21,22,24,26,27,31,32,34,35,36,39,41,43,44,46,47,48,49,52,54,55,56,57,58,60,61,62,63,64,66,67,69,70,71,72,74,76,77,78,79,80,86,87,90,91,92,94,95,97,98,99,100,101,102,103,104,105,108,109,110,113,114,115,117,118,119,120,122,126,128,129,130,135,136,137,138,139,141,143,147,148,152,153,155,156,157,159,160,161,162,163,165,166,167,168,169,172,173,176,178,180,181,182,183,184,185,186,187,189,194,195,196,199,200,202,204,206,207,211,212,214,215,216,219,220,221,224,225,227,228,229,231,232,233,234,235,236,238,239,240,242,245,246,249,250,251,252,253,254,255,257,259,260,262,264,265,266,268,269,270,271,272,273,274,275,276,277,278,279,281,283,285,286,288,289,290,291,292,293,295,296,297,299,303,308,309,311,312,313,315,320,322,323,324,326,327,329,330,331,333,335,342,344,345,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,364,365,368,369,370,371,372,374,375,379,380,382,383,384,385,387,388,389,390,391,392,394,395,396,397,398,399,401,402,403,404,405,406,407,409,411,416,419,420,421,422,423,425,426,427,429,430,431,432,435,436,439,440,442,443,445,446,448,449,452,454,456,457,458,460,461,463,464,466,467,468,469,470,471,473,475,476,478,481,482,483,484,488,490,493,496,497,498,500,501,503,504,505,507,508,510,511,512,513,514,515,516,518,520,521,523,524,526,527,528,530,533,534,535,536,537,540,541,542,543,544,546,549,551,553,554,555,557,558,559,560,561,562,567,568,570,571,575,580,582,583,587,588,589,590,591,592,593,595,596,597,598,599,600,603,604,605,611,614,615,616,618,620,621,622,623,624,625,626,628,629,631,632,633,635,636,639,640,641,642,643,644,645,646,650,651,652,653,655,656,657,662,664,667,668,669,670,672,673,678,679,680,681,682,685,689,690,691,692,693,694,697,700,701,702,705,706,708,709,711,714,715,716,717,719,720,721,723,724,725,726,727,728,729,730,731,732,733,734,736,737,739,740,741,743,744,745,746,747,748,749,754,755,757,758,759,761,762,767,769,770,773,774,775,776,778,780,781,782,783,786,787,791,793,795,796,797,798,799,800,803,804,806,807,809,810,811,812,813,814,817,819,822,823,824,825,826,827,828,829,831,832,834,837,838,839,840,841,842,843,844,846,847,848,849,851,852,854,855,856,858,861,862,865,868,871,872,874,875,876,877,878,881,882,883,884,885,886,889,890,891,893,895,896,897,898,900,902,903,904,905,908,911,913,914,915,918,919,920,921,923,926,927,929,930,931,932,933,934,935,936,937,938,940,941,942,943,944,945,946,948,949,952,957,958,960,961,964,967,968,969,973,979,980,984,985,987,988,989,990,991,992,993,994,995,996,997,998,1003,1004,1005,1006,1008,1009,1010,1011,1012,1014,1015,1017,1018,1019,1021,1022,1023,1024,1026,1027,1028,1030,1031,1033,1034,1035,1037,1038,1039,1042,1044,1045,1047,1050,1051,1052,1056,1059,1061,1062,1063,1064,1065,1067,1069,1070,1071,1072,1073,1075,1077,1080,1081,1082,1083,1085,1087,1088,1090,1091,1098,1099,1100,1102,1103,1104,1105,1106,1107,1109,1112

> group_2_indices: 2,8,10,23,29,37,38,42,45,59,65,68,73,75,85,88,89,93,106,107,111,125,127,132,133,142,150,151,154,164,171,174,175,179,191,193,198,201,203,208,217,222,226,237,244,247,261,263,267,300,301,302,304,307,310,319,321,325,328,332,336,340,341,343,346,363,373,376,377,381,386,393,400,410,414,415,417,418,424,428,434,447,453,455,462,472,477,479,485,486,491,492,494,499,502,517,519,522,525,529,531,545,547,548,550,552,556,563,564,565,566,573,576,578,579,586,594,602,610,612,617,627,637,647,648,658,660,661,671,674,683,684,686,695,722,735,750,752,764,765,766,768,771,772,777,779,785,788,790,792,802,815,818,833,835,836,850,853,859,864,866,867,869,870,873,879,880,887,892,901,907,916,917,922,925,939,950,951,953,954,956,965,966,974,975,977,978,981,986,1000,1007,1013,1016,1032,1041,1048,1049,1053,1057,1074,1076,1089,1095,1096,1101,1111


#### CBF Output
> group_1_indices: 0,2,3,4,5,6,7,8,10,12,15,16,18,19,20,21,23,24,26,27,28,29,30,31,32,33,35,37,38,39,41,42,43,45,46,47,49,51,52,54,55,56,57,59,60,61,63,64,65,67,68,69,71,73,74,75,76,78,80,82,84,85,86,87,88,89,90,91,93,95,96,99,105,106,107,109,110,111,113,114,115,116,117,118,119,121,122,123,125,126,127,128,129,131,132,133,134,136,138,139,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,157,159,161,162,163,164,170,171,172,173,174,175,176,178,179,180,181,183,184,185,186,187,188,189,191,193,194,195,196,197,198,199,200,201,203,205,207,208,209,211,212,213,215,216,217,220,221,222,225,226,227,228,229,230,232,234,236,237,238,240,241,242,244,245,246,247,248,249,250,251,252,255,258,259,260,261,263,264,265,266,267,268,269,270,271,272,273,274,279,280,283,284,288,289,290,291,292,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,310,311,312,313,314,317,318,319,321,322,324,325,326,327,328,330,331,332,335,336,337,338,339,340,341,342,343,344,346,351,352,355,356,358,359,360,362,363,364,366,367,368,369,371,373,374,375,376,377,378,380,381,382,384,386,388,390,392,393,394,397,400,402,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,422,423,424,425,426,427,428,430,431,432,433,434,435,436,437,439,442,444,445,446,447,448,449,451,453,454,455,456,457,458,459,461,462,463,464,465,470,471,472,473,475,476,477,478,479,482,484,485,486,489,491,492,493,494,495,496,497,498,499,501,502,505,509,510,511,513,515,516,517,518,519,520,521,522,523,525,526,528,529,530,531,532,533,534,536,538,539,542,543,545,546,547,548,550,551,552,553,554,555,556,557,558,560,562,563,564,565,566,567,568,569,573,574,576,577,578,579,580,582,583,586,587,589,590,591,592,594,595,596,597,598,599,601,602,604,605,606,607,608,609,610,611,612,616,617,618,620,624,625,627,628,631,632,633,634,635,636,637,640,641,642,646,647,648,650,654,655,657,658,660,661,662,663,664,668,669,670,671,673,674,676,677,679,680,681,682,683,684,685,686,689,691,692,693,694,695,696,697,698,699,700,702,703,704,706,707,709,710,711,712,714,715,716,717,718,720,721,722,724,726,727,728,729,730,732,734,735,737,738,739,740,742,743,746,747,748,750,752,754,755,758,760,761,762,764,765,766,767,768,769,770,771,772,773,774,775,776,777,779,784,785,786,787,788,790,791,792,793,795,796,797,802,807,809,810,811,812,813,815,817,818,820,821,822,823,824,825,827,832,833,834,835,836,839,840,841,842,844,845,846,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,866,867,869,870,871,872,873,874,875,877,879,880,881,882,883,887,888,889,890,892,893,894,895,896,900,901,902,904,907,908,910,911,912,913,914,916,917,918,919,921,922,923,924,925,926,928,929,930,931,933,935,936,937,939,940,943,944,945,946,947,949,950,951,952,953,954,957,962,963,964,965,966,968,970,971,972,973,974,975,977,978,980,981,982,983,984,986,988,989,992,995,996,997,998,1000,1005,1007,1010,1011,1012,1013,1014,1015,1016,1017,1018,1020,1021,1022,1023,1024,1025,1026,1029,1031,1032,1033,1036,1037,1038,1039,1040,1041,1042,1043,1044,1045,1047,1048,1049,1050,1051,1052,1053,1054,1056,1057,1059,1060,1062,1063,1064,1065,1068,1069,1070,1071,1073,1074,1075,1076,1077,1078,1080,1081,1082,1085,1088,1089,1090,1092,1093,1094,1095,1096,1098,1100,1101,1102,1103,1104,1106,1107,1111,1112

> group_2_indices: 1,9,11,14,22,34,36,40,44,48,58,62,66,70,72,77,79,92,94,97,98,100,101,102,103,104,108,120,130,135,137,156,160,165,166,167,168,169,177,182,202,204,206,214,219,224,231,233,235,239,253,254,257,262,275,276,277,278,281,285,286,293,309,315,320,323,329,333,345,347,348,349,350,353,354,357,361,365,370,372,379,383,385,387,389,391,395,396,398,399,401,403,421,429,440,443,452,460,466,467,468,469,481,483,488,490,500,503,504,507,508,512,514,524,527,535,537,540,541,544,549,559,561,570,571,575,588,593,600,603,614,615,621,622,623,626,629,639,643,644,645,651,652,653,656,667,672,678,687,690,701,705,708,719,723,725,731,733,736,741,744,745,749,757,759,778,780,781,782,783,789,798,799,800,803,804,806,814,819,826,828,829,831,837,838,843,847,848,849,865,868,876,878,884,885,886,891,897,898,903,905,915,920,927,932,934,938,941,942,948,956,958,960,961,967,969,979,985,987,990,991,993,994,1003,1004,1006,1008,1009,1019,1027,1028,1030,1034,1035,1061,1067,1072,1083,1087,1091,1099,1105,1109

#### NPM Output 

> group_1_indices: 0,1,2,3,6,7,8,9,10,11,12,14,18,20,21,22,23,24,26,27,29,31,32,34,36,37,38,39,40,41,42,43,44,45,47,48,49,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,84,85,86,87,88,89,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,113,114,117,118,120,122,125,127,128,129,130,132,133,135,137,138,139,141,142,143,146,147,148,150,151,152,153,154,155,156,157,160,162,163,164,165,166,167,168,169,171,172,174,175,176,177,179,180,181,182,183,185,187,189,191,193,194,195,196,198,200,201,202,203,204,205,206,207,208,209,211,214,215,216,217,219,220,221,222,224,225,226,227,228,229,231,232,233,234,235,237,238,239,240,241,242,244,245,246,247,249,250,251,252,253,254,255,257,259,260,261,262,263,264,266,267,268,269,270,271,273,274,275,276,277,278,279,281,283,285,286,288,289,290,291,292,293,295,296,297,299,300,301,302,303,304,305,307,308,309,310,311,312,313,314,315,319,320,321,322,323,324,325,327,328,329,330,331,332,333,335,336,338,340,341,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,360,361,363,364,365,368,369,370,371,372,373,374,375,376,377,379,380,381,383,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,409,410,411,414,415,416,417,418,419,420,421,422,424,425,426,427,428,429,430,431,432,434,435,436,439,440,442,443,445,446,447,448,449,452,453,454,455,456,457,458,460,461,462,464,465,466,467,468,469,470,471,472,473,475,476,477,478,479,481,482,483,484,485,486,488,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,507,508,510,511,512,513,514,515,516,517,519,520,522,523,524,525,526,527,529,530,531,533,534,535,536,537,540,541,543,544,545,546,547,548,549,550,551,552,553,554,555,556,558,559,560,561,562,563,564,565,566,568,570,571,573,574,575,576,578,579,580,582,583,586,587,588,590,591,592,593,594,596,597,598,599,600,602,603,604,605,610,611,612,614,615,616,617,618,620,621,622,623,624,625,626,627,629,631,632,633,637,639,640,641,642,643,644,645,646,647,648,650,651,652,653,655,656,657,658,660,661,662,664,667,668,669,670,671,672,673,674,678,679,680,681,682,683,684,685,686,687,689,690,691,692,693,694,695,697,700,701,702,704,705,706,707,708,709,711,714,715,716,717,719,720,721,722,723,724,725,727,728,729,730,731,732,733,734,735,736,737,740,741,743,744,745,746,748,749,750,752,755,757,758,759,760,761,762,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,795,796,797,798,799,800,802,803,804,806,807,809,810,811,812,813,814,815,817,818,819,822,823,824,825,826,827,828,829,831,832,833,835,836,837,838,839,842,843,847,848,849,850,851,852,853,854,856,858,859,861,864,865,866,867,868,869,870,871,872,873,874,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,895,896,897,898,900,901,902,903,904,905,907,908,913,914,915,916,917,919,920,921,922,923,925,927,930,931,932,933,934,938,939,941,942,943,944,945,946,948,949,950,951,952,953,954,956,957,958,960,961,963,964,965,966,967,968,969,973,974,975,977,978,979,980,981,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,1000,1003,1004,1006,1007,1008,1009,1011,1012,1013,1014,1015,1016,1017,1019,1021,1023,1024,1026,1027,1028,1030,1031,1032,1033,1034,1035,1037,1038,1039,1041,1042,1045,1048,1049,1050,1051,1052,1053,1056,1057,1059,1060,1061,1062,1063,1064,1065,1067,1069,1070,1071,1072,1073,1074,1075,1076,1077,1081,1082,1083,1085,1087,1088,1089,1090,1091,1095,1096,1099,1100,1101,1102,1104,1105,1106,1107,1109,1111
> 
> group_2_indices: 4,15,16,19,35,46,52,90,115,119,126,136,159,161,173,178,184,186,199,212,236,248,265,272,326,342,358,359,382,384,406,407,423,463,518,521,528,542,557,567,589,595,628,635,636,726,739,747,754,834,840,841,844,846,855,862,875,911,918,926,929,935,936,937,940,1005,1010,1018,1022,1044,1047,1080,1098,1103,1112


#### Leukemic burden output 

> group_1_indices: 0,1,3,4,6,7,8,9,10,11,12,14,15,16,18,19,20,21,22,23,24,26,27,29,34,37,38,40,41,42,43,44,46,48,49,52,55,56,57,58,59,61,62,63,64,65,66,67,68,69,70,71,72,73,75,76,77,80,84,85,88,89,90,91,92,93,94,95,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,113,114,115,117,118,119,120,122,126,127,128,130,132,133,135,137,138,139,141,142,143,147,150,151,152,153,154,155,156,157,159,160,161,163,164,165,166,167,168,169,171,173,176,177,178,179,180,181,182,183,184,185,186,187,189,191,194,195,196,198,199,200,202,203,204,206,207,208,209,212,214,215,217,219,220,221,222,224,225,227,228,229,231,233,234,235,236,237,238,239,240,242,245,246,247,248,249,250,251,252,253,254,255,257,260,261,262,263,264,265,266,267,268,270,271,272,273,274,275,276,277,278,281,283,285,286,288,289,290,293,295,296,297,299,300,301,302,303,304,307,308,309,310,312,314,315,319,320,321,322,323,324,325,328,329,331,332,340,341,342,343,344,345,346,348,350,351,353,354,355,356,357,358,359,360,361,363,368,369,370,371,372,373,374,375,376,377,379,380,381,382,383,384,387,388,389,390,391,393,394,396,399,401,402,403,404,405,406,407,409,410,411,415,417,418,419,420,421,422,423,424,425,426,427,428,429,430,432,434,435,436,439,440,442,443,445,446,447,448,449,452,453,455,456,457,458,460,461,462,463,464,465,466,467,468,469,470,471,472,473,476,478,479,483,484,485,486,488,493,494,495,497,498,499,500,501,503,504,505,507,510,511,512,513,514,515,516,517,518,520,521,522,523,524,526,528,529,531,533,534,535,536,537,540,541,542,543,544,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,564,566,568,570,571,573,576,578,580,582,583,586,587,588,589,590,591,592,593,594,595,597,598,599,600,604,605,610,611,612,614,615,616,618,620,622,623,624,625,626,627,628,629,631,635,636,637,639,640,641,642,644,645,646,647,650,651,652,653,657,658,660,661,662,667,668,669,670,672,674,678,679,680,681,682,683,684,685,686,687,689,690,692,693,694,695,700,702,704,706,709,711,714,716,717,719,721,722,723,724,725,726,727,728,729,730,731,733,734,735,736,739,740,741,743,744,745,746,747,748,749,750,752,754,755,757,758,759,760,764,765,766,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,784,785,786,787,788,790,791,793,796,797,798,799,800,802,803,804,806,807,809,811,812,813,814,815,817,818,819,822,824,826,827,828,829,831,832,833,834,835,836,837,838,840,841,842,843,844,847,848,849,850,851,853,854,855,856,858,859,861,862,865,866,867,868,869,870,871,872,873,874,875,877,879,880,881,882,884,885,886,888,889,890,892,893,896,897,898,901,902,903,904,905,911,913,914,915,916,917,918,919,920,923,925,926,927,929,930,931,932,934,935,936,937,938,939,940,941,942,943,944,945,946,948,949,950,951,954,956,957,958,960,961,967,968,974,975,978,979,980,984,985,986,987,988,989,990,991,994,996,997,998,1000,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015,1016,1019,1021,1022,1026,1027,1028,1031,1032,1033,1035,1038,1039,1041,1042,1044,1045,1047,1048,1049,1050,1051,1052,1053,1056,1057,1059,1060,1061,1064,1065,1067,1070,1071,1072,1073,1074,1075,1076,1077,1080,1081,1082,1083,1087,1088,1089,1090,1091,1096,1098,1099,1100,1101,1102,1103,1104,1105,1109,1111,1112

> group_2_indices: 2,31,32,35,36,39,45,47,54,60,74,78,79,86,87,96,125,129,136,148,162,172,174,175,193,201,205,211,216,226,232,241,244,259,269,279,291,292,305,311,313,326,327,330,333,335,336,338,347,349,352,364,365,385,386,392,395,397,398,400,414,416,431,454,475,477,481,482,490,491,492,496,502,508,519,525,527,530,545,563,565,567,574,575,579,596,602,603,617,621,632,633,643,648,655,656,664,671,673,691,697,701,705,707,708,715,720,732,737,761,762,767,783,789,792,795,810,823,825,839,846,852,864,876,878,883,887,891,895,900,907,908,921,922,933,952,953,963,964,965,966,969,973,977,981,992,993,995,1017,1018,1023,1024,1030,1034,1037,1062,1063,1069,1085,1095,1106,1107

#### Race output 
> group_1_indices: 0,1,2,3,4,6,8,9,10,11,12,14,15,16,19,20,23,26,27,32,34,35,36,37,38,39,40,41,42,43,44,46,47,48,49,52,54,55,58,60,61,62,63,64,65,66,67,72,73,74,75,76,77,78,79,80,84,85,86,87,89,90,91,92,93,95,96,97,98,99,100,101,103,104,106,108,109,110,111,113,115,117,118,119,122,125,126,128,132,133,136,137,139,142,143,146,147,148,150,151,152,154,155,156,157,159,160,161,162,163,164,165,167,168,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,191,194,195,196,198,199,201,202,203,204,205,207,208,209,211,212,214,215,217,220,221,222,225,226,227,228,231,233,234,236,239,240,242,244,246,248,249,252,253,254,255,257,259,260,261,262,263,264,265,266,267,268,270,271,272,274,275,276,277,278,279,281,283,285,286,289,290,291,292,293,295,296,297,299,302,303,309,310,311,312,313,315,319,320,321,322,324,325,326,327,328,329,330,331,333,335,336,338,340,342,346,347,349,350,352,356,357,358,359,360,361,363,365,369,370,372,373,374,375,379,380,382,383,384,385,386,387,388,389,390,391,392,393,395,398,400,403,404,405,406,409,410,411,414,416,417,419,422,423,424,426,427,428,429,430,431,432,435,436,440,442,445,446,447,448,449,452,454,455,456,457,460,461,462,464,465,466,467,468,471,473,475,476,477,481,482,483,484,485,486,488,495,496,497,498,499,501,502,503,504,505,508,510,512,513,514,515,516,517,518,520,521,522,524,525,526,527,528,529,530,535,536,541,542,543,545,547,549,550,551,552,553,554,555,556,557,558,561,562,563,565,567,568,573,574,575,576,578,579,580,582,583,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,602,603,604,610,611,612,614,615,616,617,618,620,621,622,624,625,626,627,628,629,631,633,635,636,637,639,641,642,643,644,645,646,647,648,650,651,653,655,656,657,658,660,661,662,664,667,668,670,671,674,679,680,681,682,683,684,685,687,689,691,692,694,700,702,705,707,708,709,715,716,717,719,720,721,723,724,725,726,727,729,730,731,732,734,735,736,737,740,741,743,744,745,746,747,748,750,752,757,758,759,760,761,762,764,765,767,768,769,770,771,772,773,774,775,777,778,779,780,781,783,784,785,786,787,788,789,790,791,792,793,795,796,800,803,804,806,809,810,811,815,817,818,819,822,825,827,828,831,832,834,837,838,841,842,843,846,847,848,849,850,851,852,854,855,858,859,861,864,865,866,868,869,870,871,872,874,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,892,893,895,897,900,901,903,904,908,911,913,914,918,920,921,923,925,926,929,930,931,932,933,934,936,937,938,940,941,942,943,944,945,946,949,951,953,954,956,957,958,961,966,968,969,973,974,977,978,979,980,981,984,985,986,987,988,989,990,991,992,994,995,996,997,998,1000,1003,1004,1005,1006,1007,1008,1009,1011,1012,1013,1014,1015,1017,1018,1019,1021,1022,1024,1026,1027,1028,1030,1031,1032,1033,1034,1035,1037,1038,1039,1041,1042,1044,1045,1048,1049,1050,1051,1052,1053,1056,1057,1059,1060,1061,1062,1063,1065,1069,1070,1071,1072,1074,1076,1080,1087,1088,1089,1090,1091,1095,1096,1098,1100,1101,1102,1103,1104,1105,1109,1111,1112


group_2_indices: 7,18,22,31,45,56,59,68,69,70,94,105,107,114,127,153,193,200,216,232,238,241,247,250,269,288,304,305,314,345,364,371,381,394,397,399,401,407,415,439,453,479,490,494,500,507,519,533,534,540,544,548,560,564,570,571,605,632,640,652,669,672,678,690,695,701,704,711,722,728,733,754,755,766,776,782,798,799,802,807,813,823,826,829,833,835,836,840,862,875,907,915,919,922,935,939,950,952,960,964,965,975,993,1016,1023,1047,1064,1067,1073,1077,1081,1082,1085,1099

#### NPM relapse output 
>group_1_indices: 15,16,35,199,248,265,358,407,528,628,636,747,844,846,855,918,1010,1018,1103,1112
>group_2_indices: 4,19,46,52,90,115,119,126,136,159,161,173,178,184,186,212,236,272,326,342,359,382,384,406,423,463,518,521,542,557,567,589,595,635,726,739,754,834,840,841,862,875,911,926,929,935,936,937,940,1005,1022,1044,1047,1080,1098

### 3. ( FOR CAVATICA RUNS ) Stats part 1: prepare the stats input to modify the subset and create a new output directory 
  - 📃 copy ```_3_prepare_stats_input.py``` to cwd. You may be able to run this in the current directory as long as the "old-ouput-dir" points ot the rmats output directory with the gtf files. But if unsure, copy this file to cwd. 

Example

```
python _3_prepare_stats_input.py --new-output-dir /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/risk-groups/ --old-output-dir /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/COG_rmats-output/2021OCT23_COG_rmats-output/ --group-1-indices 0,1,3,4,6,7,9,11,12,14,15,16,18,19,20,21,22,24,26,27,31,32,34,35,36,39,41,43,44,46,47,48,49,52,54,55,56,57,58,60,61,62,63,64,66,67,69,70,71,72,74,76,77,78,79,80,86,87,90,91,92,94,95,97,98,99,100,101,102,103,104,105,108,109,110,113,114,115,117,118,119,120,122,126,128,129,130,135,136,137,138,139,141,143,147,148,152,153,155,156,157,159,160,161,162,163,165,166,167,168,169,172,173,176,178,180,181,182,183,184,185,186,187,189,194,195,196,199,200,202,204,206,207,211,212,214,215,216,219,220,221,224,225,227,228,229,231,232,233,234,235,236,238,239,240,242,245,246,249,250,251,252,253,254,255,257,259,260,262,264,265,266,268,269,270,271,272,273,274,275,276,277,278,279,281,283,285,286,288,289,290,291,292,293,295,296,297,299,303,308,309,311,312,313,315,320,322,323,324,326,327,329,330,331,333,335,342,344,345,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,364,365,368,369,370,371,372,374,375,379,380,382,383,384,385,387,388,389,390,391,392,394,395,396,397,398,399,401,402,403,404,405,406,407,409,411,416,419,420,421,422,423,425,426,427,429,430,431,432,435,436,439,440,442,443,445,446,448,449,452,454,456,457,458,460,461,463,464,466,467,468,469,470,471,473,475,476,478,481,482,483,484,488,490,493,496,497,498,500,501,503,504,505,507,508,510,511,512,513,514,515,516,518,520,521,523,524,526,527,528,530,533,534,535,536,537,540,541,542,543,544,546,549,551,553,554,555,557,558,559,560,561,562,567,568,570,571,575,580,582,583,587,588,589,590,591,592,593,595,596,597,598,599,600,603,604,605,611,614,615,616,618,620,621,622,623,624,625,626,628,629,631,632,633,635,636,639,640,641,642,643,644,645,646,650,651,652,653,655,656,657,662,664,667,668,669,670,672,673,678,679,680,681,682,685,689,690,691,692,693,694,697,700,701,702,705,706,708,709,711,714,715,716,717,719,720,721,723,724,725,726,727,728,729,730,731,732,733,734,736,737,739,740,741,743,744,745,746,747,748,749,754,755,757,758,759,761,762,767,769,770,773,774,775,776,778,780,781,782,783,786,787,791,793,795,796,797,798,799,800,803,804,806,807,809,810,811,812,813,814,817,819,822,823,824,825,826,827,828,829,831,832,834,837,838,839,840,841,842,843,844,846,847,848,849,851,852,854,855,856,858,861,862,865,868,871,872,874,875,876,877,878,881,882,883,884,885,886,889,890,891,893,895,896,897,898,900,902,903,904,905,908,911,913,914,915,918,919,920,921,923,926,927,929,930,931,932,933,934,935,936,937,938,940,941,942,943,944,945,946,948,949,952,957,958,960,961,964,967,968,969,973,979,980,984,985,987,988,989,990,991,992,993,994,995,996,997,998,1003,1004,1005,1006,1008,1009,1010,1011,1012,1014,1015,1017,1018,1019,1021,1022,1023,1024,1026,1027,1028,1030,1031,1033,1034,1035,1037,1038,1039,1042,1044,1045,1047,1050,1051,1052,1056,1059,1061,1062,1063,1064,1065,1067,1069,1070,1071,1072,1073,1075,1077,1080,1081,1082,1083,1085,1087,1088,1090,1091,1098,1099,1100,1102,1103,1104,1105,1106,1107,1109,1112  --group-2-indices 2,8,10,23,29,37,38,42,45,59,65,68,73,75,85,88,89,93,106,107,111,125,127,132,133,142,150,151,154,164,171,174,175,179,191,193,198,201,203,208,217,222,226,237,244,247,261,263,267,300,301,302,304,307,310,319,321,325,328,332,336,340,341,343,346,363,373,376,377,381,386,393,400,410,414,415,417,418,424,428,434,447,453,455,462,472,477,479,485,486,491,492,494,499,502,517,519,522,525,529,531,545,547,548,550,552,556,563,564,565,566,573,576,578,579,586,594,602,610,612,617,627,637,647,648,658,660,661,671,674,683,684,686,695,722,735,750,752,764,765,766,768,771,772,777,779,785,788,790,792,802,815,818,833,835,836,850,853,859,864,866,867,869,870,873,879,880,887,892,901,907,916,917,922,925,939,950,951,953,954,956,965,966,974,975,977,978,981,986,1000,1007,1013,1016,1032,1041,1048,1049,1053,1057,1074,1076,1089,1095,1096,1101,1111
```

```
python _3_prepare_stats_input.py --new-output-dir /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/npm-relapse/ --old-output-dir /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/COG_rmats-output/2021OCT23_COG_rmats-output/ --group-1-indices 15,16,35,199,248,265,358,407,528,628,636,747,844,846,855,918,1010,1018,1103,1112 --group-2-indices 4,19,46,52,90,115,119,126,136,159,161,173,178,184,186,212,236,272,326,342,359,382,384,406,423,463,518,521,542,557,567,589,595,635,726,739,754,834,840,841,862,875,911,926,929,935,936,937,940,1005,1022,1044,1047,1080,1098
```
  - This took several minutes to complete and will create ~3 files for each splicing event in the new-output-dir. This may be dependent on the number of exons in that event group (how large the file is). This is the input for the stats model for rMATS (which will also take some time to complete). 


### 4. Run the rMATS stats model to calculate delta PSIs from groups of replicates. 
Submit a job to run the stats model task with rmats on the previous oputput directory: ```sbatch --time=3-0:0:0 -J stat_race--mem=32G _4_run-task-stat_race.sh``` 
  - 🌐 make sure you have rmats 4.1.2 or run ```conda install -c conda-forge -c bioconda rmats=4.1.2``` in the current environment
  - make sure the ```rmats``` that is used is the one for the current conda environment. I specified the following path: ```/home/adamsj8/miniconda3/envs/rmats2/rMATS/rmats.py```
  - ❓ I specified a ```tmp``` directory but the script made its own and I'm not sure if mine is ever used. 

### 5. Run the filtering script to determine significant delta PSIs amongst the comparison. 
This is located under the ```~/scripts``` folder and each comparison group has it's own modified script. This allows for proper sorting of the files and custom filtering that could be biologically relevant for each comparison. 
  - ✖️ Filtering criteria: ~~``` python $sc_rmats_filter ${post}${event}.MATS.${counttype}.txt 20,0.10,0.90,0.01,0.15,0.01,0.2```
    - this was too stringent, I am switching to default ```10,0.05,0.95,0.01,0.05,0.05,0.2```
  - 📃 make sure the ```rmats_filtering.py``` and the ```class_exon.py``` scripts are in the same folder as the bash script. It will ```cd``` to the appropriate folder within the BASH script to access the relevant rMATS stats output files. 
  - ```sbatch --mem=16G -J risk_filter _5_filtering_COG_risk_v1.sh``` 
  - ```sbatch --mem=16G -J cbf_filter _5_filtering_COG_cbf_v1.sh```


### 6. Generate donut and volcano plots of splicing event distributions 
  - ```Rscript _6a_plot-splicing-pies_COG_risk_v1.R```

  - For the volcano plot, make sure the order of the labels follows the order in which you passed your group1 and group1 in previous steps. 

### 7. Generate Sashimi plots 

#### 7a use ``sort_files_cavatica.py``` to create the appropriate Cavatica folders from the BAMs of interest 
  - 🌐 ``conda activate /mnt/isilon/xing_lab/aspera/adamsj/kf_python_api/cavatica-api-env`` 
    - refer to notebook/cavatica_api_notes.md for more info
    - refer to https://github.com/jeneaadams/COG-pediatric-aml/blob/e9e6d123e98976177a1c8c1db03329780fd9dc87/notebook/2022-AUG-26.md for usage 
  - ``cd /mnt/isilon/xing_lab/aspera/adamsj/kf_python_api``
  - ``python /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/scripts/sort_files_cavatica.py --project_name cog-analysis --project_path bam_files --project_id jiadams/cog-analysis --new_folder_name npm-aml --tag npm-neg --list /mnt/isilon/xing_lab/aspera/adamsj/COG-analysis_metadataV2/scripts/bam-lists/npm-neg.txt``

#### 7b run the ``rmats2sashimiplot`` Cavatica app to generate plots in Cavatica 

  - groupinfo.txt file: 
 <img width="108" alt="image" src="https://user-images.githubusercontent.com/54278292/221656231-c1716724-3709-41fb-b70d-820e262b0267.png">

  - ran on larger instances than the first N=468 run 


### 8. Extract PSI values (can be done while sashimi plots are running 



